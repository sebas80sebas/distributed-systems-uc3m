# Makefile to compile the main server and RPC server
CC = gcc
CFLAGS = -Wall -g -I/usr/include/tirpc -Wno-unused-variable
TIRPC_CFLAGS = $(shell pkg-config --cflags libtirpc)
TIRPC_LDFLAGS = $(shell pkg-config --libs libtirpc)

# Files generated by rpcgen
RPC_FILES = log_service.h log_service_clnt.c log_service_svc.c log_service_xdr.c

# Targets
all: log_server server

# Generate RPC files
$(RPC_FILES): log_service.x
	rpcgen -C log_service.x

# Modify generated files to use tirpc
fix_rpc_files: $(RPC_FILES)
	sed -i 's/<rpc\/rpc.h>/<tirpc\/rpc\/rpc.h>/g' log_service.h
	sed -i 's/#include <rpc\/pmap_clnt.h>/#include <rpc\/pmap_clnt.h>\n#include <tirpc\/rpc\/rpc.h>/g' log_service_svc.c
	sed -i 's/#include <rpc\/pmap_clnt.h>/#include <rpc\/pmap_clnt.h>\n#include <tirpc\/rpc\/rpc.h>/g' log_service_clnt.c

# Compile RPC server - Using generated implementation
log_server: log_service_impl.c $(RPC_FILES) fix_rpc_files
	$(CC) $(CFLAGS) $(TIRPC_CFLAGS) -o log_server log_service_impl.c log_service_svc.c log_service_xdr.c $(TIRPC_LDFLAGS)

# Compile main server 
server: server.c log_client.c $(RPC_FILES) fix_rpc_files
	$(CC) $(CFLAGS) $(TIRPC_CFLAGS) -o server server.c log_client.c log_service_clnt.c log_service_xdr.c $(TIRPC_LDFLAGS)

clean:
	rm -f log_server server $(RPC_FILES) *.o
